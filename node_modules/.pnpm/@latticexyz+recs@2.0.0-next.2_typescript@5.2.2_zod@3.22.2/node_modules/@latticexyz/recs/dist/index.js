import{transformIterator as j,uuid as oe}from"@latticexyz/utils";import{mapObject as D}from"@latticexyz/utils";import{filter as re,map as ie,Subject as q}from"rxjs";var W=(y=>(y[y.Boolean=0]="Boolean",y[y.Number=1]="Number",y[y.OptionalNumber=2]="OptionalNumber",y[y.BigInt=3]="BigInt",y[y.OptionalBigInt=4]="OptionalBigInt",y[y.String=5]="String",y[y.OptionalString=6]="OptionalString",y[y.NumberArray=7]="NumberArray",y[y.OptionalNumberArray=8]="OptionalNumberArray",y[y.BigIntArray=9]="BigIntArray",y[y.OptionalBigIntArray=10]="OptionalBigIntArray",y[y.StringArray=11]="StringArray",y[y.OptionalStringArray=12]="OptionalStringArray",y[y.Entity=13]="Entity",y[y.OptionalEntity=14]="OptionalEntity",y[y.EntityArray=15]="EntityArray",y[y.OptionalEntityArray=16]="OptionalEntityArray",y[y.T=17]="T",y[y.OptionalT=18]="OptionalT",y))(W||{}),Q=(r=>(r[r.Enter=0]="Enter",r[r.Exit=1]="Exit",r[r.Update=2]="Update",r[r.Noop=3]="Noop",r))(Q||{}),H=[14,16,2,8,4,10,6,12,18];function he(e,t,n){let o=e.registerEntity(n??{});if(t)for(let[r,p]of t)T(r,o,p);return o}function S(e){return Symbol.for(e)}function C(e){return Symbol.keyFor(e)}function $(e){let t=new Map;function n(a){let m=t.get(o(a));return m?new Set([...m].map(C)):new Set}function o(a){return Object.values(a).join("/")}function r(a,m){if(!m)return;let c=o(m),u=t.get(c);u||(u=new Set,t.set(c,u)),u.add(a)}function p(a,m){if(!m)return;let c=o(m),u=t.get(c);u&&u.delete(a)}for(let a of b(e)){let m=x(e,a);r(S(a),m)}let i=e.update$.subscribe(({entity:a,value:m})=>{p(S(a),m[1]),r(S(a),m[0])});return e.world.registerDisposer(()=>i?.unsubscribe()),{...e,getEntitiesWithValue:n}}import{map as ee,pipe as te}from"rxjs";function Ne(e,t){return e.component===t}function ne(e,t){let n=x(t,e);return{entity:e,component:t,value:[n,void 0],type:n==null?3:0}}function I(e){return te(ee(t=>ne(t,e)))}function B(e){return"getEntitiesWithValue"in e}function R(e,t){return Object.keys(e.schema).every(n=>n in t)}function h(e){return e.metadata?.componentName??e.metadata?.tableName??e.metadata?.tableId??e.metadata?.contractId??e.id}function Re(e,t,n){if(Object.keys(t).length===0)throw new Error("Component schema must have at least one key");let o=n?.id??oe(),r=D(t,()=>new Map),p=new q,i=n?.metadata,m={values:r,schema:t,id:o,update$:p,metadata:i,entities:()=>j(Object.values(r)[0].keys(),C),world:e};return n?.indexed&&(m=$(m)),e.registerComponent(m),m}function T(e,t,n){let o=S(t),r=x(e,t);for(let[p,i]of Object.entries(n))e.values[p]?e.values[p].set(o,i):e.metadata?.tableId&&/^\d+$/.test(p)||console.warn("Component definition for",h(e),"is missing key",p,", ignoring value",i,"for entity",t,". Existing keys: ",Object.keys(e.values));e.update$.next({entity:t,value:[n,r],component:e})}function je(e,t,n,o){let r=x(e,t);if(r===void 0){if(o===void 0)throw new Error(`Can't update component ${h(e)} without a current value or initial value`);T(e,t,{...o,...n})}else T(e,t,{...r,...n})}function w(e,t){let n=S(t),o=x(e,t);for(let r of Object.keys(e.values))e.values[r].delete(n);e.update$.next({entity:t,value:[void 0,o],component:e})}function v(e,t){let n=S(t);return Object.values(e.values)[0].has(n)}function x(e,t){let n={},o=S(t),r=Object.keys(e.schema);for(let p of r){let i=e.values[p].get(o);if(i===void 0&&!H.includes(e.schema[p]))return;n[p]=i}return n}function De(e,t){let n=x(e,t);if(!n)throw new Error(`No value for component ${h(e)} on entity ${t}`);return n}function k(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;let n=!0;for(let o of Object.keys(e))if(n=e[o]===t[o],!n)return!1;return n}function qe(e,t){return[e,t]}function A(e,t){if(B(e)&&R(e,t))return e.getEntitiesWithValue(t);let n=new Set;for(let o of b(e)){let r=x(e,o);k(t,r)&&n.add(o)}return n}function b(e){return e.entities()}function Le(e){let t=0,n=new Map,o=new Map,r=new q;function p(l,s){n.set(l,{update:s,nonce:t++}),g(s.entity,s.value)}function i(l){let s=n.get(l)?.update.entity;if(n.delete(l),s==null)return;let E=[...n.values()].filter(f=>f.update.entity===s).sort((f,N)=>f.nonce<N.nonce?-1:1);if(E.length>0){let f=E[E.length-1];g(s,f.update.value)}else g(s,void 0)}function a(l){let s=x(e,l),E=S(l),f=o.get(E);return(s||f)&&f!==null?{...s,...f}:void 0}let m=l=>({get(s,E){return E==="get"?f=>{let N=s.get(f),M=o.get(f);return M&&M[l]!=null?M[l]:N}:E==="has"?f=>s.has(f)||o.has(f):E==="keys"?()=>new Set([...s.keys(),...o.keys()]).values():Reflect.get(s,E,s)}}),c={};for(let l of Object.keys(e.values))c[l]=new Proxy(e.values[l],m(l));let u=c,d=new Proxy(e,{get(l,s){return s==="addOverride"?p:s==="removeOverride"?i:s==="values"?u:s==="update$"?r:s==="entities"?()=>new Set([...j(o.keys(),C),...l.entities()]).values():Reflect.get(l,s)},has(l,s){return s==="addOverride"||s==="removeOverride"?!0:s in l}});function g(l,s){let E=S(l),f=a(l);s!==void 0?o.set(E,s):o.delete(E),r.next({entity:l,value:[a(l),f],component:d})}return e.update$.pipe(re(l=>!o.get(S(l.entity))),ie(l=>({...l,component:d}))).subscribe(r),d}function L(e,t){return`localcache-${t}-${e.id}`}function Ke(e,t){localStorage.removeItem(L(e,t))}function Je(e,t){let{world:n,update$:o,values:r}=e,p=L(e,t),i=0,a=Date.now(),m=localStorage.getItem(p);if(m){let u=JSON.parse(m),d={};for(let[g,l]of u)for(let[s,E]of l)d[s]=d[s]||{},d[s][g]=E;for(let[g,l]of Object.entries(d)){let s=n.registerEntity({id:g});T(e,s,l)}console.info("Loading component",h(e),"from local cache.")}let c=o.subscribe(()=>{i++;let u=JSON.stringify(Object.entries(D(r,d=>[...d.entries()].map(g=>[C(g[0]),g[1]]))));localStorage.setItem(p,u),i>200&&console.warn("Component",h(e),"was locally cached",i,"times since",new Date(a).toLocaleTimeString(),"- the local cache is in an alpha state and should not be used with components that update frequently yet")});return e.world.registerDisposer(()=>c?.unsubscribe()),e}import{concat as xe,EMPTY as ge,from as Ee}from"rxjs";import{filterNullish as ae}from"@latticexyz/utils";import{observable as ue}from"mobx";import{concat as pe,concatMap as ye,filter as U,from as se,map as me,merge as le,of as de,share as ce}from"rxjs";var K=(i=>(i[i.Has=0]="Has",i[i.HasValue=1]="HasValue",i[i.Not=2]="Not",i[i.NotValue=3]="NotValue",i[i.ProxyRead=4]="ProxyRead",i[i.ProxyExpand=5]="ProxyExpand",i))(K||{});function Ge(e){return[2,4,6,14,16,8,10,12].includes(e)}function Xe(e){return[7,8,9,10,11,12,15,16].includes(e)}function Ze(e){return[1,2].includes(e)}function _e(e){return[13,14].includes(e)}function Ft(e){return{type:0,component:e}}function Qt(e){return{type:2,component:e}}function It(e,t){return{type:1,component:e,value:t}}function wt(e,t){return{type:3,component:e,value:t}}function kt(e,t){return{type:4,component:e,depth:t}}function Nt(e,t){return{type:5,component:e,depth:t}}function O(e,t){if(t.type===0)return v(t.component,e);if(t.type===1)return k(t.value,x(t.component,e));if(t.type===2)return!v(t.component,e);if(t.type===3)return!k(t.value,x(t.component,e));throw new Error("Unknown query fragment")}function fe(e){return e.type===0||e.type==1}function Y(e){return e.type===2||e.type==3}function Se(e){return e.type===5||e.type==4}function G(e,t){return e&&fe(t)||!e&&Y(t)}function J(e,t,n){let o=e,r=!1;for(let p=0;p<n.depth;p++){let i=x(n.component,o);if(!i)return null;let a=i.value;if(!a)return null;if(o=a,r=O(o,t),G(r,t))return r}return r}function P(e,t,n){if(n===0)return new Set;let o=A(t,{value:e});if(n===1)return o;let r=[...o].map(p=>[...P(p,t,n-1)]).flat();return new Set([...o,...r])}function z(e,t){let n=t?new Set([...t]):void 0,o,r;for(let p=0;p<e.length;p++){let i=e[p];if(Se(i))i.type===4&&(o=i),i.type===5&&(r=i);else if(n)for(let a of[...n]){let m=O(a,i);if(o&&o.depth>0&&!G(m,i)&&(m=J(a,i,o)??m),m||n.delete(a),r&&r.depth>0){let c=P(a,r.component,r.depth);for(let u of c)(O(u,i)||o&&o.depth>0&&J(u,i,o))&&n.add(u)}}else{if(Y(i))throw new Error("First EntityQueryFragment must be Has or HasValue");if(n=i.type===0?new Set([...b(i.component)]):A(i.component,i.value),r&&r.depth>0)for(let a of[...n])for(let m of P(a,r.component,r.depth))n.add(m)}}return n??new Set}function V(e,t){let n=t?.runOnInit||t?.initialSet?z(e,t.initialSet):new Set,o=ue(n),r=se(o).pipe(I(e[0].component)),p=e.findIndex(a=>[5,4].includes(a.type))!==-1,i=le(...e.map(a=>a.component.update$)).pipe(p?ye(a=>{let m=z(e,t?.initialSet),c=[];for(let u of o)m.has(u)||(o.delete(u),c.push({entity:u,type:1,component:a.component,value:[void 0,void 0]}));for(let u of m)o.has(u)?c.push({entity:u,type:2,component:a.component,value:[x(a.component,u),void 0]}):(o.add(u),c.push({entity:u,type:0,component:a.component,value:[x(a.component,u),void 0]}));return de(...c)}):me(a=>{if(o.has(a.entity))return e.filter(d=>d.component.id===a.component.id).every(d=>O(a.entity,d))?{...a,type:2}:(o.delete(a.entity),{...a,type:1});if(e.every(c=>O(a.entity,c)))return o.add(a.entity),{...a,type:0}}),ae());return{matching:o,update$:pe(r,i).pipe(ce())}}function X(e,t){return V(e,t).update$.pipe(U(n=>n.type===2))}function Z(e,t){return V(e,t).update$.pipe(U(n=>n.type===0))}function _(e,t){return V(e,t).update$.pipe(U(n=>n.type===1))}function F(e,t,n){let o=t.subscribe(n);e.registerDisposer(()=>o?.unsubscribe())}function Bt(e,t,n,o={runOnInit:!0}){F(e,X(t,o),n)}function Rt(e,t,n,o={runOnInit:!0}){F(e,Z(t,o),n)}function jt(e,t,n,o={runOnInit:!0}){F(e,_(t,o),n)}function Ce(e,t,n,o={runOnInit:!0}){F(e,V(t,o).update$,n)}function Dt(e,t,n,o={runOnInit:!0}){let r=o?.runOnInit?Ee(b(t)).pipe(I(t)):ge;F(e,xe(r,t.update$),n)}function qt(e,t,n,o,r={update:!1,runOnInit:!0}){Ce(e,t,({entity:p,type:i})=>{i===0&&T(n(p),p,o(p)),i===1&&w(n(p),p),r?.update&&i===2&&T(n(p),p,o(p))},r)}import{transformIterator as Te}from"@latticexyz/utils";function Yt(){let e=new Set,t=[],n=[];function o({id:u,idSuffix:d}={}){let g=u||e.size+(d?"-"+d:""),l=S(g);return e.add(l),g}function r(){return Te(e.values(),C)}function p(u){t.push(u)}function i(u){for(let[,d]of n.filter(g=>!u||g[0]===u))d();n=n.filter(d=>u&&d[0]!==u)}function a(u,d=""){n.push([d,u])}function m(u){let d=S(u);return e.has(d)}function c(u){for(let d of t)v(d,u)&&w(d,u);e.delete(S(u))}return{registerEntity:o,components:t,registerComponent:p,dispose:i,registerDisposer:a,hasEntity:m,getEntities:r,entitySymbols:e,deleteEntity:c}}function Gt(e,t){return{...e,registerDisposer:n=>e.registerDisposer(n,t),dispose:()=>e.dispose(t)}}function Xt(e,t){return e.components.filter(n=>v(n,t))}export{Ft as Has,It as HasValue,Qt as Not,wt as NotValue,H as OptionalTypes,Nt as ProxyExpand,kt as ProxyRead,K as QueryFragmentType,W as Type,Q as UpdateType,Ke as clearLocalCache,k as componentValueEquals,he as createEntity,$ as createIndexer,Je as createLocalCache,Yt as createWorld,Re as defineComponent,Dt as defineComponentSystem,Z as defineEnterQuery,Rt as defineEnterSystem,_ as defineExitQuery,jt as defineExitSystem,V as defineQuery,F as defineRxSystem,qt as defineSyncSystem,Ce as defineSystem,X as defineUpdateQuery,Bt as defineUpdateSystem,P as getChildEntities,b as getComponentEntities,x as getComponentValue,De as getComponentValueStrict,A as getEntitiesWithValue,Xt as getEntityComponents,C as getEntityString,S as getEntitySymbol,v as hasComponent,Xe as isArrayType,Ne as isComponentUpdate,_e as isEntityType,R as isFullComponentValue,B as isIndexer,Ze as isNumberType,Ge as isOptionalType,Gt as namespaceWorld,Le as overridableComponent,w as removeComponent,z as runQuery,T as setComponent,ne as toUpdate,I as toUpdateStream,je as updateComponent,qe as withValue};
//# sourceMappingURL=index.js.map