import{A as Lt,B as Gt,C as $t,D as Ut,E as Wt,F as Qt,G as _t,H as Kt,I as Pe,J as Xt,K as Y,L as j,a as Pt,b as It,c as Nt,d as Se,e as A,f as Q,g as Rt,h as _,i as Et,j as At,k as K,l as Ot,m as ke,n as X,o as q,q as J,r as z,s as H,v as Vt,w as Mt,x as Ft,y as Bt,z as Dt}from"./chunk-UU7EGKXM.js";import{a as Z}from"./chunk-6YQVEG3Y.js";import{computed as O,observable as Ee,toJS as Ae}from"mobx";import{Wallet as Ie}from"ethers";function ee(e,t){return new Ie(e,t.json)}import{combineLatest as Oe,concatMap as Ve,EMPTY as Me,filter as re,map as Fe,throttleTime as Be}from"rxjs";import{ReplaySubject as Ne}from"rxjs";function te(e){let{initialTime:t,period:a}=e,r={currentTime:t,lastUpdateTime:t,time$:new Ne(1),dispose:()=>clearInterval(u),update:n},u=s();c();function c(){r.time$.next(r.currentTime)}function s(){return setInterval(()=>{r.currentTime+=a,c()},a)}function n(m){clearInterval(u),r.currentTime=m,r.lastUpdateTime=m,c(),u=s()}return r}import{Wallet as ne}from"ethers";import{computedToStream as De}from"@latticexyz/utils";import{privateKeyToAccount as Le}from"viem/accounts";import{fallback as oe,webSocket as ie,http as se,createPublicClient as Ge,createWalletClient as $e}from"viem";import*as Ue from"@latticexyz/common/chains";import*as We from"viem/chains";async function pr(e){let t=Ee(e),a=[],{providers:r,connected:u,dispose:c}=await X(O(()=>Ae(t.provider)));a.push(c);let s=O(()=>{let o=r.get();if(t.provider.externalProvider)return o.json.getSigner();let l=t.privateKey;if(l&&o)return ee(l,o)}),n=t.provider.externalProvider?await s.get()?.getAddress():void 0,m=O(()=>t.privateKey?new ne(t.privateKey).address.toLowerCase():n?.toLowerCase()),f=O(()=>t.privateKey?new ne(t.privateKey).address:n),{blockNumber$:b,dispose:w}=q(r);a.push(w);let y=te(t.clock);a.push(y.dispose);let h=Oe([b,De(r)]).pipe(Be(t.clock.syncInterval,void 0,{leading:!0,trailing:!0}),Ve(([o,l])=>l?_(l.json,o):Me),Fe(o=>o.timestamp*1e3),re(o=>o!==y.lastUpdateTime),re(o=>o!==y.currentTime)).subscribe(y.update);a.push(()=>h?.unsubscribe());try{let o=Object.values({...Ue,...We});t.chainConfig&&o.unshift(t.chainConfig);let l=o.find(d=>d.id===t.chainId);if(!l)throw new Error(`No chain found for chain ID ${t.chainId}`);let C=Ge({chain:l,transport:oe([ie(),se()]),pollingInterval:t.provider.options?.pollingInterval??t.clock.period??1e3}),g=t.privateKey?Le(t.privateKey):null,i=g?$e({account:g,chain:l,transport:oe([ie(),se()]),pollingInterval:t.provider.options?.pollingInterval??t.clock.period??1e3}):null;z.next(C),H.next(i)}catch(o){console.error("Could not initialize viem clients, dev tools may not work:",o)}return{providers:r,signer:s,connected:u,blockNumber$:b,dispose:()=>{for(let o of a)o()},clock:y,config:t,connectedAddress:m,connectedAddressChecksummed:f}}import{Contract as ae}from"ethers";import{computed as V}from"mobx";import{mapObject as ce}from"@latticexyz/utils";async function br({config:e,asyncConfig:t,signerOrProvider:a}){let r=V(()=>ce(e,s=>s&&new ae(s.address,s.abi,a.get())));if(!t)return{contracts:r,config:e};let u=await t(r.get()),c=V(()=>ce(u,s=>s&&new ae(s.address,s.abi,a.get())));return{contracts:V(()=>({...r.get(),...c.get()})),config:{...e,...u}}}import{BaseContract as Qe}from"ethers";import{autorun as _e,computed as M,observable as Ke,runInAction as F}from"mobx";import{mapObject as ue,deferred as Xe,uuid as qe,awaitValue as Je,cacheUntilReady as ze}from"@latticexyz/utils";import{Mutex as He}from"async-mutex";function me(e,t,a,r){let{concurrency:u}=r||{},c=je(),s=new He,n=Ke.box(null),m=M(()=>{let i=t.connected.get(),d=e.get(),p=t.signer.get(),v=t.providers.get()?.json,x=n.get();if(!(i!==2||!d||!p||!v||x==null))return{contracts:d,signer:p,provider:v,nonce:x}}),f=0;async function b(){F(()=>n.set(null));let i=await t.signer.get()?.getTransactionCount()??null;F(()=>n.set(i))}let w=_e(b);function y(){F(()=>{let i=n.get(),d=i==null?null:i+1;n.set(d)})}function h(i,d,p){let[v,x,P]=Xe(),T=p.length>0&&Ye(p[p.length-1]),I=T?p[p.length-1]:{},R=T?p.slice(0,p.length-1):p,D=i.interface.fragments.find(S=>S.name===d),Te=D&&D.stateMutability,L=I.gasLimit,we=L==null?()=>i.estimateGas[d](...p):()=>L,ve=async(S,xe)=>{try{let k=i.populateTransaction[d];if(k==null)throw new Error("Member does not exist.");if(!(k instanceof Function))throw new Error(`Internal TxQueue error: Member is not a function and should not be proxied. Tried to call "${String(d)}".`);let G={gasPrice:a.getValue(),...I,nonce:S,gasLimit:xe};r?.devMode&&(G.gasPrice=0);let E=await k(...R,G);E.nonce=S,E.chainId=t.config.chainId;let N;try{let W=await i.signer.signTransaction(E);N=await i.provider.perform("sendTransaction",{signedTransaction:W})}catch{N=(await i.signer.sendTransaction(E)).hash}let $=i.provider.getTransaction(N),U=async()=>(await $).wait();return v({hash:N,wait:U,response:$}),{hash:N,wait:U}}catch(k){throw x(k),k}};return c.add(qe(),{execute:ve,estimateGas:we,cancel:S=>x(S??new Error("TX_CANCELLED")),stateMutability:Te}),o(),P}async function o(){if(u!=null&&f>=u)return;let i=c.next();if(!i)return;f++,o();let d=await s.runExclusive(async()=>{let p,v=i.stateMutability,x;try{x=await i.estimateGas()}catch(T){return console.error("[TXQueue] GAS ESTIMATION ERROR",T),i.cancel(T)}let{nonce:P}=await Je(m);try{return await i.execute(P,x)}catch(T){console.warn("[TXQueue] TXQUEUE EXECUTION FAILED",T),p=T}finally{let T=p&&"transaction"in p&&!("insufficient funds"in p)&&!("mispriced"in p)&&i.stateMutability!=="view",I=!p&&v!=="view"||T,R=p&&("code"in p&&p.code==="NONCE_EXPIRED"||JSON.stringify(p).includes("transaction already imported"));console.log(`[TXQueue] TX Sent (error=${!!p}, isMutationError=${!!T} incNonce=${!!I} resetNonce=${!!R})`),I&&y(),R&&await b(),p&&i.cancel(p)}});if(d?.hash)try{await d.wait()}catch(p){console.warn("[TXQueue] tx failed in block",p),K(d.hash,t.providers.get().json).then(T=>console.warn("[TXQueue] Revert reason:",T)).catch(T=>"This transaction didn't make it into a block. Was it mispriced?");let P=`mud trace --config deploy.json --world ${new URLSearchParams(window.location.search).get("worldAddress")} --tx ${d.hash}`;console.log("---------- DEBUG COMMANDS (RUN IN TERMINAL) -------------"),console.log("Trace:"),console.log(P),console.log("---------------------------------------------------------")}f--,o()}function l(i){return ue(i,(d,p)=>p in Qe.prototype||!(d instanceof Function)?d:(...v)=>h(i,p,v))}let C=M(()=>{let i=m.get()?.contracts;if(i)return ue(i,l)});return{txQueue:ze(C),dispose:w,ready:M(()=>m?!0:void 0)}}function Ye(e){return typeof e!="object"||Array.isArray(e)||e===null?!1:"gasLimit"in e||"gasPrice"in e||"maxFeePerGas"in e||"maxPriorityFeePerGas"in e||"nonce"in e||"type"in e||"accessList"in e||"customData"in e||"value"in e||"blockTag"in e||"from"in e}function je(){let e=new Map;function t(){return[...e.entries()].sort((n,m)=>n[1].priority>=m[1].priority?-1:1)}function a(n,m,f=1){e.set(n,{element:m,priority:f})}function r(n){e.delete(n)}function u(n,m){let f=e.get(n);f&&e.set(n,{...f,priority:m})}function c(){if(e.size===0)return;let[n,m]=t()[0];return e.delete(n),m.element}function s(){return e.size}return{add:a,remove:r,setPriority:u,next:c,size:s}}import{fromWorker as Ze}from"@latticexyz/utils";import{map as et,Subject as pe,timer as tt}from"rxjs";function Lr(e,t){let a=t?.thread||"worker",r=new pe,u=new pe,c;e=e||tt(0,16).pipe(et(()=>Y));let s=e.subscribe(r);if(a==="worker"){let n=new Worker(new URL("./workers/Sync.worker.js",import.meta.url),{type:"module"}),m=Ze(n,r).subscribe(u);c=()=>{n.terminate(),m?.unsubscribe(),s?.unsubscribe()}}else{let n=new j().work(r).subscribe(u);c=()=>{n?.unsubscribe(),s?.unsubscribe()}}return{ecsEvents$:u,input$:r,dispose:c}}import{ethers as B,VoidSigner as rt}from"ethers";function Ur(e){let t=[];for(let a of Object.keys(e)){let{abi:r,topics:u}=e[a],c=new B.Contract(B.constants.AddressZero,r,new rt(B.constants.AddressZero)),s=[u.map(n=>c.filters[n]().topics).map(n=>(n||[])[0])];t.push({key:a,topics:s})}return t}import{BigNumber as nt}from"ethers";import{defaultAbiCoder as ot}from"ethers/lib/utils.js";function le(e,t){if(Array.isArray(e))return e.map(a=>le(a,Q[t]));if(typeof e=="number"||typeof e=="string"||typeof e=="boolean")return e;if(e=nt.from(e),[1,2,3,8,9,10].includes(t))return e.toNumber();if([4,5,6,11,12,13,14,16,17].includes(t))return e.toHexString();if([15].includes(t))return e.toString();throw new Error("Unknown value type")}function Jr(e,t){return a=>{let r=ot.decode(t.map(c=>A[c]),a);if(e.length!==t.length)throw new Error("Component schema keys and values length does not match");let u={};for(let c=0;c<e.length;c++)u[e[c]]=le(r[c],t[c]);return u}}import{defaultAbiCoder as it}from"ethers/lib/utils.js";function Zr(e,t){return a=>{let r=[],u=Object.values(a);for(let c of Object.keys(a)){let s=e.findIndex(n=>n===c);r.push(A[t[s]])}return it.encode(r,u)}}import{getComponentEntities as st,getComponentValue as at}from"@latticexyz/recs";import{deferred as ct,keccak256 as de,toEthAddress as ut}from"@latticexyz/utils";import{Contract as mt}from"ethers";import{observable as pt,runInAction as fe}from"mobx";function dn(e,t,a,r,u,c){let s=pt.box({}),n=Object.keys(r).reduce((o,l)=>({...o,[de(l)]:l}),{});function m(o){let[l,,C]=ct();return fe(()=>{s.set({...s.get(),[o.id]:o.contract}),n[de(o.id)]=o.id,l()}),C}let f={};for(let o of st(a)){let l=h(o,t.signer.get());l&&(f[l.id]=l.contract)}fe(()=>s.set(f)),a.update$.subscribe(o=>{if(!o.value[0])return;let l=h(o.entity,t.signer.get());l&&m(l)});let{txQueue:b,dispose:w}=me(s,t,u,c);return e.registerDisposer(w),{systems:b,registerSystem:m,getSystemContract:y};function y(o){let l=n[o];return{name:l,contract:s.get()[l]}}function h(o,l){let{value:C}=at(a,o)||{};if(!C)throw new Error("System entity not found");let g=n[C];if(!g){console.warn("Unknown system:",C);return}return{id:g,contract:new mt(ut(o),r[g],l)}}}import{from as ye,map as lt,Subject as dt}from"rxjs";import{spawn as ft}from"threads";import{createChannel as ge,createClient as Ce}from"nice-grpc-web";import{awaitPromise as yt,awaitStreamValue as gt}from"@latticexyz/utils";import{grpc as Ct}from"@improbable-eng/grpc-web";import{ECSRelayServiceDefinition as be}from"@latticexyz/services/ecs-relay";async function Sn(e,t,a){let r=Ce(be,ge(t)),u=Ce(be,ge(t,Ct.WebsocketTransport())),c=await ft(new Worker(new URL("./workers/Recover.worker.js",import.meta.url),{type:"module"})),s={signature:await e.signMessage("ecs-relay-service")};await r.authenticate(s);let n=ye(u.openStream(s)).pipe(lt(async i=>({message:i,address:await c.recoverAddress(i)})),yt());function m(i){r.subscribe({signature:s,subscription:{label:i}})}function f(i){r.unsubscribe({signature:s,subscription:{label:i}})}async function b(){let{count:i}=await r.countConnected({});return i}let w=new dt,y={done:!1};async function*h(){for(;!y.done;)yield await gt(w)}let o=ye(u.pushStream(h())).subscribe();function l(){y.done=!0,o?.unsubscribe()}async function C(i,d){let p={version:1,id:Date.now()+a,timestamp:Date.now(),data:d,signature:""};p.signature=await e.signMessage(Z(p)),w.next({label:i,message:p})}function g(){return r.ping(s)}return{event$:n,dispose:l,subscribe:m,unsubscribe:f,push:C,countConnected:b,ping:g}}import{FaucetServiceDefinition as bt}from"@latticexyz/services/faucet";import{createChannel as ht,createClient as Tt}from"nice-grpc-web";function Rn(e){return Tt(bt,ht(e))}async function An(e,t={priorityFeeMultiplier:1}){let a=await e.getChainId(),r={nonce:await e.getTransactionCount()},u={};await s(t.priorityFeeMultiplier);async function c(n,m,f,b={retryCount:0}){let w=`${m}(${f.map(y=>`'${y}'`).join(",")})`;console.log(`executing transaction: ${w} with nonce ${r.nonce}`);try{let{argsWithoutOverrides:y,overrides:h}=wt(f),l={type:2,gasLimit:h.gasLimit??await n.estimateGas[m].apply(null,f),nonce:r.nonce++,...u,...h},C=await n.populateTransaction[m](...y,l);C.chainId=a;let g;try{let d=await e.signTransaction(C);g=await e.provider.perform("sendTransaction",{signedTransaction:d})}catch(d){console.warn("signing failed, falling back to sendTransaction",d),g=(await e.sendTransaction(C)).hash}J.next(g);let i=e.provider.getTransaction(g);return{hash:g,tx:i}}catch(y){if(y?.message.includes("transaction already imported")){if(b.retryCount===0)return s(t.priorityFeeMultiplier*1.1),c(n,m,f,{retryCount:b.retryCount++});throw new Error(`Gas estimation error for ${w}: ${y?.reason}`)}throw y}}async function s(n){let m=await e.provider.getFeeData();if(!m.lastBaseFeePerGas)throw new Error("Can not fetch lastBaseFeePerGas from RPC");u.maxPriorityFeePerGas=m.lastBaseFeePerGas.eq(0)?0:Math.floor(15e8*n),u.maxFeePerGas=m.lastBaseFeePerGas.mul(2).add(u.maxPriorityFeePerGas)}return{fastTxExecute:c,updateFeePerGas:s,gasConfig:u,currentNonce:r}}function wt(e){let t=e.length>0&&vt(e[e.length-1]),a=t?e[e.length-1]:{};return{argsWithoutOverrides:t?e.slice(0,e.length-1):e,overrides:a}}function vt(e){return typeof e!="object"||Array.isArray(e)||e===null?!1:"gasLimit"in e||"gasPrice"in e||"maxFeePerGas"in e||"maxPriorityFeePerGas"in e||"nonce"in e||"type"in e||"accessList"in e||"customData"in e||"value"in e||"blockTag"in e||"from"in e}import{TableId as xt}from"@latticexyz/common/deprecated";var he=[{inputs:[{internalType:"bytes32",name:"tableId",type:"bytes32"}],name:"snapSync_system_getNumKeysInTable",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"tableId",type:"bytes32"},{internalType:"uint256",name:"limit",type:"uint256"},{internalType:"uint256",name:"offset",type:"uint256"}],name:"snapSync_system_getRecords",outputs:[{components:[{internalType:"bytes32",name:"tableId",type:"bytes32"},{internalType:"bytes32[]",name:"keyTuple",type:"bytes32[]"},{internalType:"bytes",name:"value",type:"bytes"}],internalType:"struct SyncRecord[]",name:"",type:"tuple[]"}],stateMutability:"view",type:"function"}];import{Contract as St}from"ethers";async function Gn(e,t,a,r){let u=new St(e,he,r),c=100,s=t.map(m=>m.toHex()),n=[];for(let m of s){let f=(await u.callStatic.snapSync_system_getNumKeysInTable(m,{blockTag:a})).toNumber();if(f===0)continue;let b=f,w=Math.ceil(f/c);for(let y=0;y<w;y++){let h=Math.min(b,c),o=y*c;b-=h;let C=(await u.callStatic.snapSync_system_getRecords(m,h,o,{blockTag:a})).map(g=>({tableId:xt.fromHex(g[0]),keyTuple:g[1],value:g[2]}));n.push(...C)}}return n}export{ke as ConnectionState,Se as ContractSchemaValue,Q as ContractSchemaValueArrayToElement,A as ContractSchemaValueId,Kt as GodID,Xt as InputType,Pt as NetworkEvents,_t as SingletonID,Qt as SyncState,j as SyncWorker,Y as ack,q as createBlockNumberStream,Mt as createCacheStore,te as createClock,br as createContracts,Jr as createDecoder,Zr as createEncoder,An as createFastTxExecutor,Rn as createFaucetService,pr as createNetwork,Ot as createProvider,X as createReconnectingProvider,Sn as createRelayStream,ee as createSigner,Lr as createSyncWorker,dn as createSystemExecutor,Ur as createTopics,me as createTxQueue,Rt as ensureNetworkIsUp,_ as fetchBlock,At as fetchEventsInBlockRange,Et as fetchLogs,le as flattenValue,Vt as getCacheId,Dt as getCacheStoreEntries,Ut as getIndexDBCacheStoreBlockNumber,Wt as getIndexDbECSCache,K as getRevertReason,Gn as getSnapSyncRecords,Nt as isNetworkComponentUpdateEvent,It as isSystemCallEvent,Pe as keyTupleToEntityID,$t as loadIndexDbCacheStore,Lt as mergeCacheStores,Z as messagePayload,Gt as saveCacheStoreToIndexDb,Ft as storeEvent,Bt as storeEvents};
//# sourceMappingURL=index.js.map