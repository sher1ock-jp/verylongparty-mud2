import{a as L}from"./chunk-64VNNNML.js";import{defineComponent as ye,Type as Ce}from"@latticexyz/recs";function ge(t){return ye(t,{value:Ce.OptionalNumber},{id:"DevHighlight"})}import{defineComponent as be,Type as xe}from"@latticexyz/recs";function Se(t,e){return be(t,{value:xe.Number},e)}import{defineComponent as ve,Type as Te}from"@latticexyz/recs";function he(t,e){return ve(t,{value:Te.Boolean},e)}import{defineComponent as Ee,Type as Q}from"@latticexyz/recs";function we(t,e){return Ee(t,{x:Q.Number,y:Q.Number},e)}import{defineComponent as Me,Type as Ae}from"@latticexyz/recs";function k(t,e){return Me(t,{value:Ae.String},e)}import{defineComponent as Ne,Type as M}from"@latticexyz/recs";function R(t){return Ne(t,{state:M.Number,on:M.OptionalEntity,metadata:M.OptionalT,overrides:M.OptionalStringArray,txHash:M.OptionalString},{id:"Action"})}import{defineComponent as ke,Type as V}from"@latticexyz/recs";function We(t,e){return ke(t,{x:V.Number,y:V.Number,z:V.Number},e)}import{getComponentValue as Oe,getComponentValueStrict as P,Has as De,hasComponent as E,HasValue as Re,runQuery as Ve,componentValueEquals as Ie}from"@latticexyz/recs";import{keccak256 as Pe}from"@latticexyz/utils";import{BigNumber as I}from"ethers";import{SingletonID as Ue}from"@latticexyz/network";import{deferred as $e}from"@latticexyz/utils";import{filter as Be}from"rxjs";function Pn(t,e){return Fe(t,e.currentTime/1e3)}function Fe(t,e){let o=He(t);if(!o)return-1;let r=I.from(o.startTime),i=I.from(o.turnLength);return I.from(Math.floor(e)).sub(r).div(i).toNumber()}function He(t){return Oe(t,Ue)}function Un(t,e,o){return Ve([Re(e,o),De(t)]).size>0}function $n(t,e){if(!t)return;let o=t;if(!(o==null||!E(e,o)))return o}function Bn(t,e){for(;E(t,e);){let o=P(t,e).value;if(!o)return;e=o}return e}function Fn(t,e,o){if(E(o,e))return e;for(;E(t,e);){let r=P(t,e).value;if(r==null)return;if(e=r,E(o,e))return e}}function Hn(t,e,o){if(e===o)return!0;for(;E(t,e);){let r=P(t,e).value;if(r==null)return!1;if(e=r,e===o)return!0}return!1}function je(t){let e=new Array(4);function o(c){for(let s=0;s<e.length;s++)e[s]=0;for(let s=0;s<c.length;s++)e[s%4]=(e[s%4]<<5)-e[s%4]+c.charCodeAt(s)}function r(){let c=e[0]^e[0]<<11;return e[0]=e[1],e[1]=e[2],e[2]=e[3],e[3]=e[3]^e[3]>>19^c^c>>8,(e[3]>>>0)/(1<<31>>>0)}function i(){let c=Math.floor(r()*360)/360,s=80/100,m=70/100;return[c,s,m]}function l(c,s,m){return c<<16|s<<8|m}function u(c,s,m){return m<0&&(m+=1),m>1&&(m-=1),m<1/6?c+(s-c)*6*m:m<1/2?s:m<2/3?c+(s-c)*(2/3-m)*6:c}function a(c,s,m){let b,g,n;if(s===0)b=g=n=m;else{let p=m<.5?m*(1+s):m+s-m*s,f=2*m-p;b=u(f,p,c+1/3),g=u(f,p,c),n=u(f,p,c-1/3)}return[b*255,g*255,n*255]}return o(t),l(...a(...i()))}function jn(t){return je(Pe(t).substring(2))}function U(t,e,o){let[r,,i]=$e(),l=r,u=t.update$.pipe(Be(a=>a.entity===e&&!!o.find(c=>Ie(c,a.value[0])))).subscribe(()=>{r(),l()});return l=()=>u?.unsubscribe(),i}async function Ln(t,e,o){await U(t,e,[o])}import{defineQuery as Le,toUpdate as Qe}from"@latticexyz/recs";import{useEffect as q,useMemo as qe,useState as K}from"react";import{filter as Ke}from"rxjs";function Ge(t,e){let[o,r]=K(e);return q(()=>{let i=t.subscribe(l=>r(l));return()=>i?.unsubscribe()},[]),o}function Zn(t,e){let o=qe(()=>e!=null?t.update$.pipe(Ke(i=>i.entity===e)):t.update$.asObservable(),[t,e]),r=Ge(o,e!=null?Qe(e,t):void 0);return r?r.value[0]:null}function eo(t){let[e,o]=K();return q(()=>{let r=Le(t,{runOnInit:!0}),i=r.update$.subscribe();return o(r.matching),()=>i?.unsubscribe()},[]),e}import{createEntity as Je,getComponentValue as O,overridableComponent as G,updateComponent as T,setComponent as _e}from"@latticexyz/recs";import{mapObject as Ye,awaitStreamValue as Xe,uuid as Ze}from"@latticexyz/utils";var W=(a=>(a[a.Requested=0]="Requested",a[a.Executing=1]="Executing",a[a.WaitingForTxEvents=2]="WaitingForTxEvents",a[a.Complete=3]="Complete",a[a.Failed=4]="Failed",a[a.Cancelled=5]="Cancelled",a[a.TxReduced=6]="TxReduced",a))(W||{}),ze={[6]:"TxReduced",[0]:"Requested",[1]:"Executing",[2]:"WaitingForTxEvents",[3]:"Complete",[4]:"Failed",[5]:"Cancelled"};import{merge as et}from"rxjs";function tt(t,e){let o=R(t),r={},i=new Map,l=new Map;t.registerDisposer(()=>{for(let{dispose:n}of l.values())n()});function u(n){let p=r[n.id]||G(n);return r[n.id]||(r[n.id]=p),p}function a(n){if(t.hasEntity(n.id))return console.warn(`Action with id ${n.id} is already requested.`),n.id;let f=Je(t,void 0,{id:n.id});_e(o,f,{state:0,on:n.on,metadata:n.metadata,overrides:void 0,txHash:void 0});for(let[y,S]of Object.entries(n.components))r[y]||(r[y]=G(S));let d={...n,entity:f,componentsWithOptimisticUpdates:Ye(n.components,y=>u(y))};i.set(d.id,d);let C=et(...Object.values(d.componentsWithOptimisticUpdates).map(y=>y.update$)).subscribe(()=>c(d));return c(d),l.set(d.id,{dispose:()=>C?.unsubscribe()}),f}function c(n){if(O(o,n.entity)?.state!==0)return;let p=n.requirement(n.componentsWithOptimisticUpdates);p&&s(n,p)}async function s(n,p){if(O(o,n.entity)?.state!==0)return;T(o,n.entity,{state:1});let f=n.updates(n.componentsWithOptimisticUpdates,p).map(d=>({...d,id:Ze()}));T(o,n.entity,{overrides:f.map(d=>`${d.id}/${d.component}`)});for(let{component:d,value:C,entity:y,id:S}of f)r[d].addOverride(S,{entity:y,value:C});try{let d=await n.execute(p);if(d){T(o,n.entity,{state:2,txHash:d.hash});let C=d.wait().catch(y=>m(y,n));await Xe(e,y=>y===d.hash),T(o,n.entity,{state:6}),n.awaitConfirmation&&await C}T(o,n.entity,{state:3})}catch(d){m(d,n)}g(n.id)}function m(n,p){console.error(n),T(o,p.entity,{state:4}),g(p.id)}function b(n){let p=i.get(n);return!p||O(o,p.entity)?.state!==0?(console.warn(`Action ${n} was not found or is not in the "Requested" state.`),!1):(T(o,p.entity,{state:5}),g(n),!0)}function g(n){if(!i.get(n)){console.warn(`Trying to remove action ${n} that does not exist.`);return}let f=n,d=f!=null&&O(o,f)?.overrides||[];for(let C of d){let[y,S]=C.split("/");r[S].removeOverride(y)}l.get(n)?.dispose(),l.delete(n),i.delete(n),f!=null&&setTimeout(()=>t.deleteEntity(f),5e3)}return{add:a,cancel:b,withOptimisticUpdates:u,Action:o}}async function z(t,e){return U(t,e,[{state:5},{state:4},{state:3}])}import{createNetwork as xt,createContracts as St,createTxQueue as vt,createSyncWorker as Tt,InputType as ht,SingletonID as Z,keyTupleToEntityID as Et}from"@latticexyz/network";import{BehaviorSubject as wt,concatMap as Mt,from as At,Subject as Nt}from"rxjs";import{defineComponent as ee,Type as A}from"@latticexyz/recs";import{computed as kt}from"mobx";import{keccak256 as Wt}from"@latticexyz/utils";import{TableId as Ot}from"@latticexyz/common/deprecated";import{IWorldKernel__factory as te}from"@latticexyz/world/types/ethers-contracts/factories/IWorldKernel.sol/IWorldKernel__factory";import{ack as J,createEncoder as nt,isNetworkComponentUpdateEvent as ot,isSystemCallEvent as rt}from"@latticexyz/network";import{getComponentValue as it,removeComponent as at,setComponent as st,getComponentEntities as mt,getComponentValueStrict as ct,updateComponent as pt}from"@latticexyz/recs";import{isDefined as ut}from"@latticexyz/common/utils";import{toEthAddress as dt}from"@latticexyz/utils";import lt from"@latticexyz/solecs/abi/Component.sol/Component.json";import{Contract as ft,BigNumber as yt}from"ethers";import{filter as Ct,map as gt,Subject as $,timer as bt}from"rxjs";function Jo(t,e,o){return r=>{let i=r.entity??t.registerEntity({id:r.entity}),l=o[r.component],u=e[l];if(!l){console.error(`Component mapping not found for component ID ${r.component} ${JSON.stringify(r.value)}`);return}return{...r,entity:i,component:u}}}function _o(t,e,o,r,i){let l=e.reduce((u,a)=>({...u,[a]:new $}),{});return{systemCallStreams:l,decodeAndEmitSystemCall:u=>{let{tx:a}=u,c=yt.from(a.to).toHexString().toLowerCase();if(!c)return;let s=it(o,c)?.value;if(!s)return;let{name:m,contract:b}=r(s),g=b.interface.parseTransaction({data:a.data,value:a.value});l[m]||(l[m]=new $),l[m].next({...u,updates:u.updates.map(i).filter(ut),systemId:m,args:g.args})}}}async function Y(t,e,o){let r={};async function i(u){let a=dt(u),c=ct(e,u).value;console.info("[SyncUtils] Creating encoder for "+a);let s=new ft(a,lt.abi,o.get()),[m,b]=await s.getSchema();r[c]=nt(m,b)}for(let u of mt(e))i(u);let l=e.update$.subscribe(u=>i(u.entity));return t.registerDisposer(()=>l?.unsubscribe()),r}function X(t,e,o,r,i,l,u,a){let c=new $,s=!1,m=bt(0,100).pipe(Ct(()=>!s),gt(()=>J)).subscribe(i),b=o.subscribe(g=>{s=!0;for(let n of g)if(ot(n)){if(n.lastEventInTx&&c.next(n.txHash),u&&l){let{namespace:C,table:y,key:S}=n,h=l.tables[y];if(!(!h||C!==l.namespace)){let w=_(S,Object.getOwnPropertyNames(h.keySchema)),N=n.value??n.partialValue;if(N){let D=_(N,Object.getOwnPropertyNames(h.schema));u.set(C,y,w,D)}else u.remove(C,y,w)}}let p=n.entity??t.registerEntity({id:n.entity}),f=r[n.component];if(!f){console.warn("Unknown component:",n);continue}let d=e[f];n.partialValue!==void 0?pt(d,p,n.partialValue,n.initialValue):n.value===void 0?at(d,p):st(d,p,n.value)}else a&&rt(n)&&a(n);i.next(J),s=!1});return t.registerDisposer(()=>{b?.unsubscribe(),m?.unsubscribe()}),{txReduced$:c.asObservable()}}function _(t,e){let o={};return e.forEach((r,i)=>{i in t&&(o[r]=t[i])}),o}import{createDatabase as Dt,createDatabaseClient as Rt}from"@latticexyz/store-cache";async function fr({networkConfig:t,world:e,contractComponents:o,initialGasPrice:r,fetchSystemCalls:i,syncThread:l,storeConfig:u,syncStoreCache:a=!0,worldAbi:c=te.abi}){L.next(c);let s=k(e,{id:"SystemsRegistry",metadata:{contractId:"world.component.systems"}}),m=k(e,{id:"ComponentsRegistry",metadata:{contractId:"world.component.components"}}),b=ee(e,{state:A.Number,msg:A.String,percentage:A.Number},{id:"LoadingState",metadata:{contractId:"component.LoadingState"}}),g=new Ot("mudstore","schema"),p={storeSchemaComponent:ee(e,{valueSchema:A.String,keySchema:A.String},{metadata:{contractId:g.toHex(),tableId:g.toString()}}),...o,SystemsRegistry:s,ComponentsRegistry:m,LoadingState:b},f={};function d(x,v){typeof v.metadata?.tableId=="string"?f[v.metadata.tableId]=x:f[Wt(typeof v.metadata?.contractId=="string"?v.metadata.contractId:v.id)]=x}for(let x of Object.keys(p))d(x,p[x]);let C=await xt(t);e.registerDisposer(C.dispose);let y=kt(()=>C.signer.get()||C.providers.get().json),{contracts:S,config:h}=await St({config:{World:{abi:te.abi,address:t.worldAddress}},signerOrProvider:y}),w=new wt(r||Math.ceil((await y.get().getGasPrice()).toNumber()*1.3)),{txQueue:N,dispose:D}=vt(S,C,w,{devMode:t.devMode});e.registerDisposer(D);let ie=e.registerEntity({id:Z}),B=C.connectedAddress.get(),ae=B?e.registerEntity({id:Et([B])}):void 0,F=new Nt,{provider:{externalProvider:Ut,...se},...me}=t,{ecsEvents$:H,input$:ce,dispose:pe}=Tt(F,{thread:l});e.registerDisposer(pe);function ue(x,v){ce.next({type:ht.Config,data:{...me,provider:se,worldContract:h.World,initialBlockNumber:v??t.initialBlockNumber,disableCache:t.disableCache||[31337,1337].includes(t.chainId),fetchSystemCalls:i,initialRecords:x}})}let de=Dt(),j=Rt(de,u),{txReduced$:le}=X(e,p,H,f,F,a?u:void 0,a?j:void 0),fe=t.encoders?Y(e,m,y):new Promise(x=>x({}));return{txQueue:N,txReduced$:le,encoders:fe,network:C,startSync:ue,gasPriceInput$:w,ecsEvent$:H.pipe(Mt(x=>At(x))),mappings:f,registerComponent:d,networkConfig:t,world:e,components:p,singletonEntityId:Z,singletonEntity:ie,playerEntity:ae,storeCache:j}}import{generatePrivateKey as Vt,privateKeyToAccount as re}from"viem/accounts";import{isHex as It}from"viem";import{BehaviorSubject as ne}from"rxjs";function oe(t,e){if(!It(t))throw console.error("Private key found in cache is not valid hex",{privateKey:t,cacheKey:e}),new Error(`Private key found in cache (${e}) is not valid hex`);re(t)}function Pt(t="mud:burnerWallet"){let e=localStorage.getItem(t);e!=null&&oe(e,t);let o=e!=null?new ne(e):(()=>{let r=Vt();return console.log("New burner wallet created:",re(r)),localStorage.setItem(t,r),new ne(r)})();return window.addEventListener("storage",function r(i){if(o.closed){window.removeEventListener("storage",r);return}if(i.key===t&&i.storageArea===localStorage){if(!i.newValue){console.warn("Burner wallet removed from cache! You may need to reload to create a new wallet.");return}oe(i.newValue,t),o.next(i.newValue)}}),o}export{W as ActionState,ze as ActionStateString,X as applyNetworkUpdates,tt as createActionSystem,Jo as createDecodeNetworkComponentUpdate,Y as createEncoders,_o as createSystemCallStreams,R as defineActionComponent,he as defineBoolComponent,we as defineCoordComponent,ge as defineDevHighlightComponent,Se as defineNumberComponent,k as defineStringComponent,We as defineVoxelCoordComponent,Fn as findEntityWithComponentInRelationshipChain,Hn as findInRelationshipChain,Pt as getBurnerWallet,Pn as getCurrentTurn,He as getGameConfig,$n as getPlayerEntity,jn as getStringColor,Fe as getTurnAtTime,Un as isUntraversable,je as randomColor,Bn as resolveRelationshipChain,fr as setupMUDV2Network,Zn as useComponentValueStream,eo as useQuery,Ge as useStream,z as waitForActionCompletion,Ln as waitForComponentValue,U as waitForComponentValueIn};
//# sourceMappingURL=index.js.map